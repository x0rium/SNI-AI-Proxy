# SNI AI Proxy

## Описание

Простой SNI-прокси для маршрутизации TLS-соединений через SOCKS5 на основе имени сервера, указанного в ClientHello.

## Требования

*   **Node.js**: Необходимая среда выполнения.
*   **pnpm**: Менеджер пакетов для установки зависимостей.
*   **Docker** (Опционально): Для сборки и запуска приложения в контейнере.

## Конфигурация

Основная конфигурация приложения находится в файле `config.yaml`.

Ключевые секции конфигурации:

*   `proxy_port`: Порт, на котором прокси будет принимать входящие TLS-соединения (например, 443).
*   `socks_proxy`: Настройки для подключения к вышестоящему SOCKS5 прокси.
    *   `host`: Адрес SOCKS5 прокси.
    *   `port`: Порт SOCKS5 прокси.
    *   `username` (Опционально): Имя пользователя для аутентификации.
    *   `password` (Опционально): Пароль для аутентификации.
*   `routing`: Правила маршрутизации на основе SNI. Определяет, какие домены должны направляться через SOCKS5 прокси, а какие - напрямую.
    *   `default`: Действие по умолчанию (`proxy` или `direct`).
    *   `rules`: Список правил для конкретных доменов или паттернов.
        *   `domain`: Домен или паттерн (например, `*.example.com`).
        *   `action`: Действие (`proxy` или `direct`).
*   `logging`: Настройки логирования с использованием `winston`.
    *   `level`: Уровень логирования (например, `info`, `debug`).
    *   `log_dir`: Директория для хранения файлов логов (по умолчанию `logs`).
    *   `max_size`: Максимальный размер файла лога.
    *   `max_files`: Максимальное количество хранимых файлов логов.

**Пример структуры `config.yaml`:**

```yaml
proxy_port: 443

socks_proxy:
  host: 127.0.0.1
  port: 1080
  # username: user
  # password: password

routing:
  default: direct # По умолчанию все идет напрямую
  rules:
    - domain: "*.internal.corp"
      action: proxy # Внутренние домены через прокси
    - domain: "secure.example.com"
      action: proxy # Конкретный домен через прокси

logging:
  level: info
  log_dir: logs
  max_size: 5242880 # 5MB
  max_files: 5
```

## Установка

Для установки зависимостей выполните команду:

```bash
pnpm install
```

## Запуск

### Локально

Для запуска прокси-сервера локально используйте:

```bash
node index.js
```

Сервер запустится на порту, указанном в `config.yaml` (`proxy_port`).

### С использованием Docker

Вы можете собрать Docker-образ и запустить приложение в контейнере.

1.  **Сборка образа:**

    ```bash
    docker build -t sni-ai-proxy:latest .
    ```

2.  **Запуск контейнера:**

    ```bash
    docker run -d -p 443:443 --name sni-proxy-container sni-ai-proxy:latest
    ```

    Эта команда запустит контейнер в фоновом режиме (`-d`), пробросит порт 443 хоста на порт 443 контейнера (`-p 443:443`) и присвоит контейнеру имя `sni-proxy-container`. Убедитесь, что порт 443 на хосте свободен.

## Логирование

Приложение использует библиотеку `winston` для логирования. Логи записываются в файлы в директории `logs` (или в директорию, указанную в `config.yaml` в секции `logging.log_dir`). Настройки ротации логов (уровень, максимальный размер файла, количество файлов) также задаются в секции `logging` файла `config.yaml`.